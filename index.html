<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="theme-color" content="#050b14" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Brisa Lounge Bar</title>

<!-- Fontes Modernas -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

<style>
/* --- VARI√ÅVEIS & RESET --- */
:root {
  --bg-body: #050b14;
  --bg-card: #0e1623;
  --bg-header: rgba(5, 11, 20, 0.85);
  --text-main: #f0f4f8;
  --text-muted: #94a3b8;
  --gold: #d4af37; /* Dourado cl√°ssico */
  --gold-dark: #b8860b;
  --danger: #ef4444;
  --success: #10b981;
  --radius: 16px;
  --font-main: 'Inter', sans-serif;
  --font-display: 'Playfair Display', serif;
  --safe-area-bottom: env(safe-area-inset-bottom);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; }
html, body { margin: 0; padding: 0; height: 100%; font-family: var(--font-main); background-color: var(--bg-body); color: var(--text-main); }

/* --- ESTRUTURA --- */
.app {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  padding-bottom: calc(100px + var(--safe-area-bottom));
}

/* --- HEADER OTIMIZADO --- */
header {
  position: sticky;
  top: 0;
  z-index: 50;
  background: var(--bg-header);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  padding-bottom: 0; /* Espa√ßo removido para a nav bar colar */
}

.header-content {
  padding: 16px 20px 10px 20px;
}

.brand-row {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 16px;
}

/* Logo Image */
.logo-img {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  object-fit: contain;
  background: #000; /* Fundo preto para destacar a logo se for PNG transparente */
  border: 1px solid rgba(212, 175, 55, 0.3);
  box-shadow: 0 0 15px rgba(212, 175, 55, 0.1);
  cursor: pointer;
  user-select: none;
  transition: transform 0.2s;
}
.logo-img:active { transform: scale(0.95); }

.brand-info h1 {
  margin: 0;
  font-family: var(--font-display);
  font-size: 22px;
  color: var(--gold);
  letter-spacing: 0.5px;
}

.brand-info p {
  margin: 2px 0 0 0;
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.connection-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--danger); /* Come√ßa vermelho (offline) */
    margin-left: auto;
    transition: background-color 0.3s, box-shadow 0.3s;
}
.connection-status.online { background-color: var(--success); box-shadow: 0 0 8px var(--success); }

/* --- BUSCA --- */
.search-container {
  position: relative;
}
.search-input {
  width: 100%;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  padding: 12px 16px 12px 44px;
  border-radius: 12px;
  color: #fff;
  font-size: 15px;
  font-family: var(--font-main);
  outline: none;
  transition: all 0.2s;
}
.search-input:focus { border-color: var(--gold); background: rgba(255,255,255,0.08); box-shadow: 0 0 0 2px rgba(212,175,55,0.1); }
.search-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  pointer-events: none;
}

/* --- CATEGORY NAV (NOVO) --- */
.category-nav {
  display: flex;
  gap: 10px;
  overflow-x: auto;
  padding: 0 20px 16px 20px;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE */
  mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
  -webkit-mask-image: linear-gradient(to right, transparent 0%, black 5%, black 95%, transparent 100%);
}
.category-nav::-webkit-scrollbar { display: none; }

.nav-pill {
  white-space: nowrap;
  padding: 8px 16px;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 20px;
  color: var(--text-muted);
  font-size: 13px;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s;
}
.nav-pill.active, .nav-pill:active {
  background: var(--gold);
  color: #000;
  border-color: var(--gold);
  font-weight: 600;
}

/* --- LISTA DE ITENS --- */
main { padding: 24px 20px; width: 100%; max-width: 800px; margin: 0 auto; }

.category-section {
  margin-bottom: 40px;
  scroll-margin-top: 180px; /* Para o scroll parar no lugar certo */
  animation: fadeIn 0.5s ease;
}

.cat-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(212, 175, 55, 0.2);
}

.cat-title {
  font-family: var(--font-display);
  font-size: 24px;
  color: var(--text-main);
  margin: 0;
}

.cat-count { font-size: 12px; color: var(--gold); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

.item-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
  border: 1px solid rgba(255,255,255,0.03);
  transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.item-card:active { transform: scale(0.98); background: rgba(255,255,255,0.08); }

.item-content { flex: 1; }
.item-name { font-weight: 600; font-size: 16px; margin-bottom: 6px; color: #fff; line-height: 1.3; }
.item-desc { font-size: 13px; color: var(--text-muted); line-height: 1.4; }

.item-price {
  font-weight: 700;
  color: var(--gold);
  font-size: 16px;
  white-space: nowrap;
  background: rgba(212, 175, 55, 0.1);
  padding: 6px 10px;
  border-radius: 8px;
  text-align: right;
  min-width: 80px;
}

/* --- TOAST NOTIFICATION (NOVO) --- */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: rgba(16, 185, 129, 0.9);
  backdrop-filter: blur(8px);
  color: white;
  padding: 12px 24px;
  border-radius: 30px;
  font-weight: 600;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  z-index: 2000;
  transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* --- ADMIN UI (FIXA) --- */
.admin-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(10, 15, 25, 0.95);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-top: 1px solid rgba(212, 175, 55, 0.3);
  padding: 12px 20px;
  padding-bottom: max(12px, var(--safe-area-bottom));
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 999;
  transform: translateY(150%);
  transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
}

.is-admin .admin-bar { transform: translateY(0); }
.is-admin .app { padding-bottom: 160px; }

.admin-actions { display: flex; gap: 10px; overflow-x: auto; padding-right: 10px; }
.admin-actions::-webkit-scrollbar { display: none; }

.btn {
  border: none;
  border-radius: 12px;
  padding: 12px 18px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: filter 0.2s;
  font-family: var(--font-main);
}

.btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: #000; box-shadow: 0 4px 12px rgba(212,175,55,0.3); }
.btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; }
.btn-danger { background: rgba(239, 68, 68, 0.1); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); }
.btn:active { transform: scale(0.96); }

.admin-card-actions {
  display: none;
  position: absolute;
  top: 8px;
  right: 8px;
  gap: 6px;
  background: rgba(0,0,0,0.8);
  padding: 4px;
  border-radius: 20px;
  backdrop-filter: blur(4px);
}
.is-admin .item-card:hover .admin-card-actions, 
.is-admin .item-card:focus-within .admin-card-actions { display: flex; }
@media (hover: none) { .is-admin .admin-card-actions { display: flex; } }

.btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--bg-body); border: 1px solid var(--gold); color: var(--gold); font-size: 16px; cursor: pointer; }

/* --- MODAL --- */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
  padding: 20px;
}
.modal-backdrop.active { display: flex; opacity: 1; }

.modal {
  background: #151e2e;
  width: 100%;
  max-width: 500px;
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  max-height: 90vh;
  animation: slideUp 0.3s ease;
}

@media (max-width: 600px) {
  .modal-backdrop { align-items: flex-end; padding: 0; }
  .modal { border-radius: 24px 24px 0 0; border-bottom: none; max-height: 85vh; width: 100%; }
}

.modal-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
.modal-title { font-family: var(--font-display); font-size: 20px; margin: 0; color: var(--gold); }
.modal-close { background: none; border: none; color: var(--text-muted); font-size: 28px; cursor: pointer; padding: 0 8px; line-height: 1; }

.modal-body { padding: 24px; overflow-y: auto; }
.modal-price-big { font-size: 32px; color: var(--gold); font-weight: 700; margin-top: 10px; text-align: right; text-shadow: 0 0 20px rgba(212,175,55,0.3); }

.form-group { margin-bottom: 16px; }
.form-label { display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-muted); }
.form-input, .form-textarea, .form-select {
  width: 100%;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  padding: 12px;
  border-radius: 10px;
  color: #fff;
  font-family: inherit;
  font-size: 15px;
}
.form-input:focus { border-color: var(--gold); outline: none; box-shadow: 0 0 0 2px rgba(212,175,55,0.1); }

.modal-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: flex-end; gap: 12px; background: rgba(0,0,0,0.2); padding-bottom: max(16px, var(--safe-area-bottom)); }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); font-style: italic; }
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="header-content">
      <div class="brand-row">
        <!-- LOGO ATUALIZADA: logo.png -->
        <img src="logo.jpg" alt="Logo Brisa" id="logoBtn" class="logo-img" title="Toque 7 vezes para Admin" onerror="this.style.display='none'">
        
        <div class="brand-info">
          <h1>Brisa Lounge</h1>
          <p>Card√°pio Digital</p>
        </div>
        <div id="connStatus" class="connection-status" title="Status da Conex√£o"></div>
      </div>
      <div class="search-container">
        <span class="search-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </span>
        <input type="text" id="searchInput" class="search-input" placeholder="O que vamos beber hoje?">
      </div>
    </div>
    
    <!-- BARRA DE NAVEGA√á√ÉO DE CATEGORIAS -->
    <nav id="catNav" class="category-nav">
      <!-- Preenchido via JS -->
    </nav>
  </header>

  <main id="menuList">
    <div class="empty-state">
      <div style="margin-bottom:10px; font-size:24px;">üç∏</div>
      Carregando card√°pio...
    </div>
  </main>
</div>

<!-- TOAST DE SUCESSO -->
<div id="toast" class="toast">
  <span>‚úì</span> <span id="toastMsg">Altera√ß√£o Salva!</span>
</div>

<!-- BARRA DE ADMINISTRA√á√ÉO FIXA -->
<div class="admin-bar" id="adminBar">
  <div style="display:flex; align-items:center; gap:10px;">
    <div style="background:var(--success);width:8px;height:8px;border-radius:50%; box-shadow:0 0 8px var(--success)"></div>
    <span style="font-size:12px; color:var(--text-muted); font-weight:bold; line-height:1.2">MODO<br>ADMIN</span>
    <div style="height:30px; width:1px; background:rgba(255,255,255,0.1); margin-left:8px;"></div>
  </div>
  <div class="admin-actions">
    <button class="btn btn-primary" onclick="openAddModal()">
      <span>+</span> Novo Item
    </button>
    <button class="btn btn-outline" onclick="addNewCategory()">Nova Se√ß√£o</button>
    <button class="btn btn-danger" onclick="toggleAdmin(false)">Sair</button>
  </div>
</div>

<!-- MODAL GERAL (Backdrop) -->
<div id="modalOverlay" class="modal-backdrop">
  <div class="modal" id="modalContent">
    <!-- Conte√∫do injetado via JS -->
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

/* --------------------- FALLBACK INITIAL DATA (completo a partir do PDF) --------------------- */
const INITIAL_DATA = {
  categories: [
    {
      id: 'drinks_brisa',
      name: 'Drinks Brisa',
      items: [
        { id: 'd_caip_cachaca', name: 'Caipirinha de Cacha√ßa (300ml)', price: 15.00, desc: 'Escolha uma fruta: Morango ou Lim√£o.' },
        { id: 'd_caip_vodka', name: 'Caipirinha de Vodka / Saqu√™ (300ml)', price: 20.00, desc: 'Escolha uma fruta: Morango ou Lim√£o.' },
        { id: 'd_caip_gourmet', name: 'Caipirinha Gourmet Brisa', price: 35.00, desc: 'Especial da casa. Escolha: Morango ou Lim√£o.' },
        { id: 'd_gin_eternity_700', name: 'Gin Eternity (700ml) - Drink', price: 15.00, desc: 'Sabores: Melancia, Tropical, Ma√ß√£ Verde e Royale.' },
        { id: 'd_gin_eternity_500', name: 'Gin Eternity (500ml) - Drink', price: 10.00, desc: 'Sabores: Melancia, Tropical, Ma√ß√£ Verde e Royale.' },
        { id: 'd_gin_premium_rb', name: 'Gin Premium & Red Bull', price: 30.00, desc: 'Escolha o sabor: Melancia ou Tropical. Com fruta.' },
        { id: 'd_copao_premium_rb', name: 'Cop√£o Premium & Red Bull (300ml)', price: 40.00, desc: 'Escolha o sabor: Melancia ou Tropical. Com fruta.' },
        { id: 'd_moscow', name: 'Moscow Mule (Tradicional)', price: 30.00, desc: 'Tradicional.' },
        { id: 'd_copao', name: 'Cop√£o', price: 30.00, desc: 'Red Label + energ√©tico (700ml).' }
      ]
    },

    {
      id: 'combos',
      name: 'Combos / Garrafas',
      items: [
        { id: 'c_redlabel', name: 'Red Label + Energ√©tico (cop√£o/700ml)', price: 30.00, desc: 'Cop√£o com energ√©tico.' },
        { id: 'c_whitehorse', name: 'White Horse + Energ√©tico', price: 25.00, desc: '' },
        { id: 'c_jack_rb', name: "Jack Daniel's + Red Bull", price: 50.00, desc: '' },
        { id: 'c_sm_ir', name: 'Smirnoff + Energ√©tico', price: 20.00, desc: '' },
        { id: 'c_absolut_rb', name: 'Absolut + Red Bull', price: 40.00, desc: '' },
        { id: 'c_jack_macaverde', name: "Jack Daniel's Ma√ß√£ Verde + Red Bull", price: 55.00, desc: '' },
        { id: 'c_gin_tanqueray', name: 'Gin Tanqueray (garrafa)', price: 250.00, desc: 'Acompanha garrafa + frutas + 4 Red Bull ou 5 t√¥nicas.' },
        { id: 'c_ciroc', name: 'Ciroc Tradicional (garrafa)', price: 320.00, desc: 'Acompanha garrafa + 4 gelos de sabores + 4 Red Bull.' },
        { id: 'c_jack_tradicional', name: "Jack Daniel's Tradicional (garrafa)", price: 280.00, desc: 'Acompanha garrafa + 4 gelos de sabores + 4 Red Bull.' },
        { id: 'c_jack_sabores', name: "Jack Daniel's Sabores (garrafa)", price: 300.00, desc: 'Acompanha garrafa + 4 gelos de sabores + 4 Red Bull.' },
        { id: 'c_chivas12', name: 'Chivas 12 anos (garrafa)', price: 250.00, desc: 'Acompanha garrafa + 4 gelos de sabores + 4 Red Bull.' },
        { id: 'c_absolut_garrafa', name: 'Absolut (garrafa)', price: 200.00, desc: 'Acompanha garrafa + 4 gelos de sabores + 4 Red Bull.' },
        { id: 'c_malibu_garrafa', name: 'Malibu (garrafa)', price: 120.00, desc: 'Observa√ß√£o: energ√©tico Bally.' },
        { id: 'c_malibu_shot', name: 'Malibu (dose)', price: 30.00, desc: '' }
      ]
    },

    {
      id: 'doses',
      name: 'Doses',
      items: [
        { id: 'dose_licor43', name: 'Licor 43 (dose)', price: 18.00, desc: '' },
        { id: 'dose_licor_ballena', name: 'Licor Ballena (dose)', price: 18.00, desc: '' },
        { id: 'dose_tequila', name: 'Tequila (Jose Cuervo) (dose)', price: 18.00, desc: '' },
        { id: 'dose_jack', name: 'Jack (dose)', price: 30.00, desc: '' }
      ]
    },

    {
      id: 'cervejas',
      name: 'Cervejas & Baldes',
      items: [
        { id: 'beer_original_600', name: 'Original (600ml)', price: 15.00, desc: 'Garrafa gelada.' },
        { id: 'beer_spaten_600', name: 'Spaten (600ml)', price: 17.00, desc: 'Puro malte.' },
        { id: 'beer_heineken_600', name: 'Heineken (600ml)', price: 19.00, desc: 'Premium.' },
        { id: 'balde_original_4', name: 'Balde Original (4 unidades)', price: 56.00, desc: '' },
        { id: 'balde_spaten_4', name: 'Balde Spaten (4 unidades)', price: 64.00, desc: '' },
        { id: 'balde_heineken_4', name: 'Balde Heineken (4 unidades)', price: 72.00, desc: '' },
        { id: 'balde_heineken_10', name: 'Balde Heineken Long (10 unidades)', price: 110.00, desc: '' },
        { id: 'longneck_heineken', name: 'Heineken (long neck)', price: 12.00, desc: '' },
        { id: 'longneck_heineken_0', name: 'Heineken 0%', price: 12.00, desc: '' },
        { id: 'skol_beats', name: 'Skol Beats', price: 12.00, desc: '' },
        { id: 'budweiser', name: 'Budweiser', price: 8.00, desc: '' },
        { id: 'corona', name: 'Corona', price: 12.00, desc: '' },
        { id: 'smirnoff_ice', name: 'Smirnoff Ice', price: 12.00, desc: '' }
      ]
    },

    {
      id: 'diversos',
      name: 'Diversos / Sem √Ålcool',
      items: [
        { id: 'refri_suco', name: 'Refrigerante / Suco (lata)', price: 6.00, desc: 'Coca-Cola, Guaran√°, Sprite, Fanta e Del Valle.' },
        { id: 'agua', name: '√Ågua (com ou sem g√°s)', price: 5.00, desc: '' },
        { id: 'agua_tonica', name: '√Ågua T√¥nica', price: 6.00, desc: '' },
        { id: 'redbull', name: 'Red Bull', price: 12.00, desc: '' },
        { id: 'gelo_sabores', name: 'Gelo Sabores', price: 3.00, desc: '' },
        { id: 'halls_trident', name: 'Halls / Trident', price: 3.50, desc: '' },
        { id: 'snickers', name: 'Snickers', price: 6.00, desc: '' }
      ]
    },

    {
      id: 'narguile',
      name: 'Narguil√©',
      items: [
        { id: 'n_rosh', name: 'Rosh', price: 15.00, desc: '' },
        { id: 'n_aluguel', name: 'Aluguel narguil√© (taxa inicial)', price: 5.00, desc: 'Cobrado no primeiro atendimento.' }
      ]
    },

    {
      id: 'porcoes',
      name: 'Por√ß√µes',
      items: [
        { id: 'p_calabresa', name: 'Calabresa', price: 30.00, desc: '' },
        { id: 'p_batata_cheddar_bacon', name: 'Batata com Cheddar e Bacon', price: 35.00, desc: '' },
        { id: 'p_onion_rings', name: 'Onion Rings', price: 25.00, desc: '' },
        { id: 'p_salgados_fritos', name: 'Salgados Fritos', price: 25.00, desc: '' },
        { id: 'p_mista', name: 'Por√ß√£o Mista (Escolha 2 itens exceto peixe)', price: 40.00, desc: '' },
        { id: 'p_isca_peixe', name: 'Isca de Peixe', price: 60.00, desc: '' },
        { id: 'p_frango_passarinho', name: 'Frango a Passarinho', price: 35.00, desc: '' }
      ]
    },

    {
      id: 'caldos_tabuas',
      name: 'Por√ß√µes, Caldos e T√°buas',
      items: [
        { id: 'caldo_verde', name: 'Caldo Verde (500ml)', price: 18.00, desc: '' },
        { id: 'caldo_feijao', name: 'Caldo de Feij√£o (500ml)', price: 18.00, desc: '' },
        { id: 'mocoto', name: 'Mocot√≥ (500ml)', price: 20.00, desc: '' },
        { id: 'abobora_carne_seca', name: 'Ab√≥bora com Carne Seca (500ml)', price: 20.00, desc: '' },
        { id: 't_completa', name: 'Por√ß√£o Completa', price: 120.00, desc: 'Acompanha isca de peixe mais 2 op√ß√µes de sua escolha.' },
        { id: 't_picanha', name: 'T√°bua Picanha com Batata (‚âà600g)', price: 100.00, desc: 'Aproximadamente 600g de picanha + molho da casa, barbecue, vinagrete e farofa.' },
        { id: 't_linguica', name: 'T√°bua Lingui√ßa com Aligot (‚âà500g)', price: 70.00, desc: 'Aproximadamente 500g de lingui√ßa + molho da casa, vinagrete e farofa.' }
      ]
    }
  ]
};

/* --------------------- FIREBASE / APP CONFIG (guarded) --------------------- */
/* This block protects the script from throwing if __firebase_config isn't injected. */
let firebaseConfig = null;
try {
  if (typeof __firebase_config !== 'undefined' && __firebase_config) {
    firebaseConfig = JSON.parse(__firebase_config);
  } else {
    console.warn('No __firebase_config provided ‚Äî running in offline/fallback mode.');
  }
} catch (err) {
  console.warn('Failed to parse __firebase_config:', err);
  firebaseConfig = null;
}

let app = null;
let db = null;
let auth = null;
if (firebaseConfig) {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  } catch (e) {
    console.error('Firebase init error:', e);
    app = null; db = null; auth = null;
  }
}

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
const MENU_DOC_PATH = ['artifacts', appId, 'public', 'data', 'menu_store', 'main'];

/* --------------------- GLOBAL STATE --------------------- */
let data = INITIAL_DATA;
let isAdmin = false;
let currentUser = null;

/* --------------------- UTILITIES --------------------- */
function escapeHtml(str = '') {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

window.formatCurrency = function(val) {
  if (val === undefined || val === null) return 'R$ 0,00';
  return Number(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
};

/* --------------------- ATTEMPT TO LOAD LOCAL JSON (menu_final_brisa.json) --------------------- */
async function tryLoadLocalJson() {
  const candidates = [
    './menu_final_brisa.json',
    'menu_final_brisa.json',
    './menu.json',
    'menu.json'
  ];
  for (const p of candidates) {
    try {
      // cache-bust to reflect edits while developing
      const res = await fetch(p + '?v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) continue;
      const j = await res.json();
      // basic validation
      if (j && Array.isArray(j.categories) && j.categories.length > 0) {
        data = j;
        console.log('Loaded local menu JSON from', p);
        renderMenu();
        return true;
      }
    } catch (e) {
      // ignore and try next
    }
  }
  return false;
}

/* --------------------- LOGO FALLBACK --------------------- */
(function ensureLogo() {
  const img = document.getElementById('logoBtn');
  if (!img) return;
  const tryPaths = ['logo.jpg','logo.png','/assets/logo.jpg','/assets/logo.png'];
  let idx = 0;
  img.onerror = () => {
    idx++;
    if (idx < tryPaths.length) img.src = tryPaths[idx];
    else img.style.display = 'none';
  };
  if (!img.getAttribute('src')) img.src = tryPaths[0];
})();

/* --------------------- FIREBASE AUTH & SYNC (guarded) --------------------- */
async function initAuth() {
  if (!auth) return;
  try {
    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
      await signInWithCustomToken(auth, __initial_auth_token);
    } else {
      await signInAnonymously(auth);
    }
  } catch (err) {
    console.error("Auth init error", err);
  }
}
if (auth) initAuth();

if (auth) {
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    const statusEl = document.getElementById('connStatus');
    if (user) {
      statusEl.classList.add('online');
      setupRealtimeSync();
    } else {
      statusEl.classList.remove('online');
    }
  });
} else {
  // no firebase -> ensure connection indicator shows offline and render fallback
  const statusEl = document.getElementById('connStatus');
  if (statusEl) statusEl.classList.remove('online');
}

/* setupRealtimeSync should only run if Firestore (db) is available */
function setupRealtimeSync() {
  if (!db) return;
  try {
    const docRef = doc(db, ...MENU_DOC_PATH);
    onSnapshot(docRef, (snapshot) => {
      if (snapshot.exists()) {
        const cloud = snapshot.data();
        if (cloud && cloud.categories) {
          data = cloud;
          renderMenu();
          console.log("Menu sincronizado com Firestore.");
        }
      }
    }, (err) => {
      console.error("sync err", err);
    });
  } catch (e) {
    console.error(e);
  }
}

/* --------------------- RENDERING --------------------- */
window.renderMenu = function() {
  const menuListEl = document.getElementById('menuList');
  const catNavEl = document.getElementById('catNav');
  const searchInput = document.getElementById('searchInput');
  const term = searchInput ? searchInput.value.toLowerCase() : '';

  menuListEl.innerHTML = '';
  if (catNavEl) catNavEl.innerHTML = '';

  if (!data || !data.categories) {
    menuListEl.innerHTML = '<div class="empty-state">Card√°pio vazio.</div>';
    return;
  }

  let hasContent = false;

  data.categories.forEach((cat, catIndex) => {
    const filteredItems = (cat.items || []).filter(item =>
      (item.name || '').toLowerCase().includes(term) ||
      (item.desc || '').toLowerCase().includes(term)
    );
    if (filteredItems.length === 0) return;
    hasContent = true;

    // Nav pill
    if (catNavEl) {
      const navLink = document.createElement('a');
      navLink.className = 'nav-pill';
      navLink.href = '#' + cat.id;
      navLink.innerText = cat.name;
      navLink.addEventListener('click', (e) => {
        e.preventDefault();
        const el = document.getElementById(cat.id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.querySelectorAll('.nav-pill').forEach(el => el.classList.remove('active'));
        navLink.classList.add('active');
      });
      catNavEl.appendChild(navLink);
      if (catIndex === 0) setTimeout(() => navLink.classList.add('active'), 0);
    }

    // Section
    const section = document.createElement('section');
    section.className = 'category-section';
    section.id = cat.id;

    const header = document.createElement('div');
    header.className = 'cat-header';

    const headerLeft = document.createElement('div');
    headerLeft.innerHTML = `<h2 class="cat-title">${escapeHtml(cat.name)}</h2><span class="cat-count">${filteredItems.length} op√ß√µes</span>`;
    header.appendChild(headerLeft);

    if (isAdmin) {
      const adminWrap = document.createElement('div');
      adminWrap.className = 'admin-card-actions';
      adminWrap.style.position = 'static';
      adminWrap.style.display = 'flex';
      adminWrap.style.background = 'transparent';
      const btnDelCat = document.createElement('button');
      btnDelCat.className = 'btn btn-icon';
      btnDelCat.title = 'Deletar se√ß√£o';
      btnDelCat.innerText = 'üóë';
      btnDelCat.onclick = () => deleteCategory(cat.id);
      adminWrap.appendChild(btnDelCat);
      header.appendChild(adminWrap);
    }
    section.appendChild(header);

    filteredItems.forEach(item => {
      const card = document.createElement('article');
      card.className = 'item-card';
      const content = document.createElement('div');
      content.className = 'item-content';
      const title = document.createElement('div');
      title.className = 'item-name';
      title.innerHTML = escapeHtml(item.name || '');
      const desc = document.createElement('div');
      desc.className = 'item-desc';
      desc.innerHTML = escapeHtml(item.desc || 'Toque para ver detalhes');
      content.appendChild(title); content.appendChild(desc);

      const priceEl = document.createElement('div');
      priceEl.className = 'item-price';
      priceEl.innerText = window.formatCurrency(item.price);

      card.appendChild(content);
      card.appendChild(priceEl);

      card.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        openItemModal(item);
      });

      if (isAdmin) {
        const actions = document.createElement('div');
        actions.className = 'admin-card-actions';
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-icon';
        btnEdit.innerText = '‚úé';
        btnEdit.onclick = (ev) => { ev.stopPropagation(); openEditModal(cat.id, item.id); };
        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-icon';
        btnDel.style.borderColor = 'var(--danger)';
        btnDel.style.color = 'var(--danger)';
        btnDel.innerText = '‚úï';
        btnDel.onclick = (ev) => { ev.stopPropagation(); deleteItem(cat.id, item.id); };

        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);
        card.appendChild(actions);
      }

      section.appendChild(card);
    });

    menuListEl.appendChild(section);
  });

  if (!hasContent) {
    menuListEl.innerHTML = `<div class="empty-state">Nenhum item encontrado para "${escapeHtml(term)}"</div>`;
  }
};

/* --------------------- SEARCH HOOK --------------------- */
document.getElementById('searchInput').addEventListener('input', window.renderMenu);

/* --------------------- MODAL / CRUD --------------------- */
const modalOverlay = document.getElementById('modalOverlay');
const modalContent = document.getElementById('modalContent');
window.closeModal = function() {
  modalOverlay.classList.remove('active');
  setTimeout(() => { modalContent.innerHTML = ''; }, 300);
};
modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) window.closeModal(); });

window.openItemModal = function(item) {
  modalContent.innerHTML = `
    <div class="modal-header">
      <h3 class="modal-title">Detalhes</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <h2 style="color:var(--gold); margin-top:0; line-height:1.2; font-family:var(--font-display)">${escapeHtml(item.name)}</h2>
      <p style="color:var(--text-muted); font-size:16px; line-height:1.5; margin-bottom:20px;">
        ${escapeHtml(item.desc || 'Sem descri√ß√£o adicional.')}
      </p>
      <div style="height:1px; background:rgba(255,255,255,0.1); margin:10px 0;"></div>
      <div class="modal-price-big">${window.formatCurrency(item.price)}</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" style="width:100%; justify-content:center" onclick="closeModal()">Fechar</button>
    </div>
  `;
  modalOverlay.classList.add('active');
};

window.openEditModal = function(catId, itemId = null) {
  const category = data.categories.find(c => c.id === catId);
  if (!category) return;
  const isNew = !itemId;
  const item = itemId ? { ...category.items.find(i => i.id === itemId) } : { name:'', price:'', desc:'' };

  modalContent.innerHTML = `
    <div class="modal-header">
      <h3 class="modal-title">${isNew ? 'Novo Item' : 'Editar Item'}</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nome do Item</label>
        <input type="text" id="inpName" class="form-input" value="${escapeHtml(item.name || '')}" placeholder="Ex: Gin T√¥nica">
      </div>
      <div class="form-group">
        <label class="form-label">Pre√ßo (R$)</label>
        <input type="number" id="inpPrice" class="form-input" value="${item.price || ''}" placeholder="0.00" step="0.50">
      </div>
      <div class="form-group">
        <label class="form-label">Descri√ß√£o / Ingredientes</label>
        <textarea id="inpDesc" class="form-textarea" rows="4" placeholder="Ex: Acompanha gelo de sabor...">${escapeHtml(item.desc || '')}</textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" id="saveItemBtn">${isNew ? 'Salvar' : 'Salvar'}</button>
    </div>
  `;
  modalOverlay.classList.add('active');

  document.getElementById('saveItemBtn').addEventListener('click', () => saveItem(catId, itemId || ''));
};

window.openAddModal = function() {
  if (!data.categories || data.categories.length === 0) {
    alert("Crie uma se√ß√£o primeiro!");
    return;
  }
  const catOptions = data.categories.map(c => `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join('');
  modalContent.innerHTML = `
    <div class="modal-header">
      <h3 class="modal-title">Adicionar onde?</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Selecione a Categoria</label>
        <select id="selCat" class="form-select">${catOptions}</select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" style="width:100%; justify-content:center" id="continueCreate">Continuar</button>
    </div>
  `;
  modalOverlay.classList.add('active');
  document.getElementById('continueCreate').addEventListener('click', () => {
    const catId = document.getElementById('selCat').value;
    closeModal();
    setTimeout(() => openEditModal(catId), 300);
  });
};

window.saveItem = async function(catId, itemId) {
  const name = document.getElementById('inpName').value.trim();
  const priceVal = document.getElementById('inpPrice').value;
  const price = priceVal ? parseFloat(priceVal) : 0;
  const desc = document.getElementById('inpDesc').value.trim();
  if (!name) return alert('Nome obrigat√≥rio.');
  const catIndex = data.categories.findIndex(c => c.id === catId);
  if (catIndex === -1) return;
  if (itemId) {
    const itemIndex = data.categories[catIndex].items.findIndex(i => i.id === itemId);
    if (itemIndex > -1) {
      data.categories[catIndex].items[itemIndex] = { id: itemId, name, price, desc };
    }
  } else {
    const newItem = { id: 'it_' + Date.now() + Math.random().toString(36).substr(2,5), name, price, desc };
    data.categories[catIndex].items.push(newItem);
  }
  await window.saveDataToCloud();
  closeModal();
};

window.deleteItem = async function(catId, itemId) {
  if (!confirm('Apagar este item?')) return;
  const cat = data.categories.find(c => c.id === catId);
  if (cat) {
    cat.items = cat.items.filter(i => i.id !== itemId);
    await window.saveDataToCloud();
  }
};

window.addNewCategory = async function() {
  const name = prompt('Nome da nova se√ß√£o (Ex: Vinhos):');
  if (name && name.trim()) {
    data.categories.push({ id: 'cat_' + Date.now(), name: name.trim(), items: [] });
    await window.saveDataToCloud();
  }
};

window.deleteCategory = async function(catId) {
  if (!confirm('Isso apagar√° a se√ß√£o inteira. Continuar?')) return;
  data.categories = data.categories.filter(c => c.id !== catId);
  await window.saveDataToCloud();
};

/* --------------------- SAVE WITH DEBOUNCE --------------------- */
let savePending = false;
let saveTimer = null;
window.saveDataToCloud = async function() {
  if (!db) return alert("Sem conex√£o com Firestore. Recarregue ou ative o modo online para salvar.");
  if (savePending) return;
  savePending = true;
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async () => {
    try {
      const docRef = doc(db, ...MENU_DOC_PATH);
      await setDoc(docRef, data);
      window.showToast("Altera√ß√£o Salva!");
    } catch (e) {
      alert("Erro ao salvar: " + (e.message || e));
    } finally {
      savePending = false;
    }
  }, 300);
};

/* --------------------- TOAST --------------------- */
window.showToast = function(msg) {
  const toast = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMsg');
  toastMsg.innerText = msg || "Salvo com sucesso!";
  toast.classList.add('show');
  setTimeout(() => { toast.classList.remove('show'); }, 3000);
};

/* --------------------- ADMIN (tap -> password modal) --------------------- */
const logoBtn = document.getElementById('logoBtn');
let tapCount = 0;
let tapTimer;
const ADMIN_PASS = 'brisa2026'; // idealmente n√£o no client

window.toggleAdmin = function(status) {
  isAdmin = Boolean(status);
  document.body.classList.toggle('is-admin', isAdmin);
  renderMenu();
};

function showAdminPwdModal() {
  modalContent.innerHTML = `
    <div class="modal-header">
      <h3 class="modal-title">√Årea Administrativa</h3>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Senha:</label>
        <input type="password" id="adminPwd" class="form-input" placeholder="Senha administrativa">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-primary" id="confirmAdmin">Entrar</button>
    </div>
  `;
  modalOverlay.classList.add('active');
  document.getElementById('confirmAdmin').addEventListener('click', () => {
    const val = document.getElementById('adminPwd').value;
    if (val === ADMIN_PASS) {
      toggleAdmin(true);
      closeModal();
      window.showToast("Modo Admin Ativado!");
    } else {
      alert('Senha incorreta.');
    }
  });
}

if (logoBtn) {
  logoBtn.addEventListener('click', (e) => {
    e.preventDefault();
    tapCount++;
    clearTimeout(tapTimer);
    if (tapCount === 7) {
      tapCount = 0;
      showAdminPwdModal();
    } else {
      tapTimer = setTimeout(() => { tapCount = 0; }, 700);
    }
  });
}

/* --------------------- INITIALIZATION --------------------- */
document.getElementById('searchInput').focus();

// Try local JSON first; if not available, render INITIAL_DATA and rely on Firestore sync.
tryLoadLocalJson().then(found => {
  if (!found) {
    // no local JSON found: keep INITIAL_DATA and render now
    data = INITIAL_DATA;
    renderMenu();
  }
});
</script>


</body>
</html>

