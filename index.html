<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Card√°pio ‚Äî Brisa (Minimal Mobile)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#071126;            /* fundo inspirado no PDF */
    --muted:#99a7b8;
    --gold:#DAA640;          /* tom dourado do PDF */
    --gold-2:#FFB86B;
    --glass: rgba(255,255,255,0.03);
    --card-radius:14px;
    --shadow: 0 10px 30px rgba(2,6,15,0.55);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: linear-gradient(180deg,#040918 0%, var(--bg) 100%);
    color:#eef6fb;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    font-size:16px;
    line-height:1.28;
  }

  /* wrapper / app shell */
  .app{min-height:100vh;padding:14px;padding-bottom:120px;display:flex;flex-direction:column;gap:12px}
  header{display:flex;gap:12px;align-items:center}
  .logo{
    width:60px;height:60px;border-radius:14px;
    background:linear-gradient(135deg,var(--gold),var(--gold-2));
    display:flex;align-items:center;justify-content:center;font-weight:700;color:#071021;font-size:20px;
    box-shadow:var(--shadow);flex:0 0 60px;user-select:none;touch-action:manipulation;
  }
  .brand{display:flex;flex-direction:column}
  .brand h1{margin:0;font-size:18px;font-family:Poppins,Inter,system-ui}
  .brand p{margin:0;margin-top:4px;color:var(--muted);font-size:13px}

  /* search */
  .search-row{display:flex;gap:10px;align-items:center;margin-top:6px}
  .search{
    flex:1;display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:var(--glass);
    border:1px solid rgba(255,255,255,0.03);
  }
  .search svg{opacity:0.95}
  .search input{border:0;background:transparent;outline:none;color:inherit;font-size:15px;width:100%}

  /* list / categories */
  .list{display:flex;flex-direction:column;gap:12px;margin-top:6px}
  .cat{
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:var(--shadow);
    transition:transform .18s ease, box-shadow .18s;
  }
  .cat:hover{transform:translateY(-4px)}
  .cat-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .cat-name{font-family:Poppins,Inter;font-weight:700;font-size:15px}
  .cat-meta{font-size:13px;color:var(--muted)}

  .items{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);
    transition:background .12s, transform .12s;
  }
  .item:active{transform:scale(.998)}
  .item-left{display:flex;flex-direction:column;gap:6px;max-width:68%}
  .iname{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .inote{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .price{font-weight:800;color:var(--gold);min-width:90px;text-align:right}

  /* Admin elements: hidden and inaccessible unless admin mode */
  .admin{display:none !important}
  body.is-admin .admin{display:inline-flex !important}

  /* ensure admin elements are removed from keyboard flow when hidden */
  .admin[aria-hidden="true"]{pointer-events:none;opacity:0;user-select:none}

  /* floating add button - admin only */
  .fab{
    position:fixed;right:18px;bottom:96px;width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--gold),var(--gold-2));
    display:flex;align-items:center;justify-content:center;font-size:26px;color:#071021;border:none;box-shadow:0 12px 36px rgba(3,7,18,0.6);z-index:60;cursor:pointer;
  }

  /* bottom bar (admin controls) */
  .bottom{
    position:fixed;left:12px;right:12px;bottom:14px;height:64px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
    display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border:1px solid rgba(255,255,255,0.03);z-index:70;gap:8px;
  }
  .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--gold),var(--gold-2));color:#071021;border:none}

  /* modal */
  .modal-wrap{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;padding:18px;z-index:90}
  .modal{width:100%;max-width:820px;background:linear-gradient(180deg,#071226,#051223);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
  .modal h3{margin:0;font-family:Poppins,Inter}
  .frow{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:15px}

  .modal-wrap.show{display:flex}

  /* responsive */
  @media(min-width:720px){
    .app{padding:22px 40px 160px}
    .logo{width:72px;height:72px}
    .price{min-width:110px}
    .fab{right:28px;bottom:120px}
    .bottom{left:24px;right:24px;bottom:28px}
  }

  /* focus */
  button:focus,input:focus,select:focus,textarea:focus{outline:2px solid rgba(255,255,255,0.06);outline-offset:2px}
</style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="logo" id="logo" title="Toque longo (segredo) ‚Äî √°rea interna"></div>
      <div class="brand">
        <h1>Brisa Lounge</h1>
        <p>Card√°pio ‚Äî toque no item para ver detalhes</p>
      </div>
    </header>

    <div class="search-row">
      <div class="search" role="search" aria-label="Pesquisar no card√°pio">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/></svg>
        <input id="q" placeholder="Procurar (ex: Caipirinha, Heineken)" inputmode="search" />
      </div>
    </div>

    <main class="list" id="list" aria-live="polite"></main>
  </div>

  <!-- admin-only controls (DOM present but hidden to users; not keyboard-focusable when hidden) -->
  <button class="fab admin" id="fab" aria-hidden="true" tabindex="-1" title="Adicionar item">+</button>

  <div class="bottom admin" id="bottomBar" aria-hidden="true">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnAddCat" class="btn" aria-hidden="true" tabindex="-1">Adicionar se√ß√£o</button>
      <button id="btnAddItem" class="btn" aria-hidden="true" tabindex="-1">Adicionar item</button>
      <button id="btnAdmin" class="btn" aria-hidden="true" tabindex="-1">√Årea interna</button>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="urlLoad" type="text" placeholder="Cole a URL p√∫blica do card√°pio" aria-hidden="true" tabindex="-1" style="background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted);min-width:140px" />
      <button id="btnLoadUrl" class="btn" aria-hidden="true" tabindex="-1">Trazer card√°pio</button>
      <button id="btnExport" class="btn" aria-hidden="true" tabindex="-1">Salvar c√≥pia</button>
    </div>
  </div>

  <div id="modalRoot" class="modal-wrap" aria-hidden="true"></div>
  <input id="fileIn" type="file" accept="application/json" style="display:none" />

<script>
/* Minimal mobile ‚Äî linha a linha revisado
 - admin controls are present in DOM but fully hidden and removed from keyboard flow for normal users
 - reveal admin via long-press (1.2s) or 7 quick taps on logo, then enter password
 - default password: brisa2026 (client-side SHA-256 stored). Change inside admin panel.
 - data persisted in localStorage key 'cardapio_min_v3'
 - labels written in natural language (Portuguese) as requested
*/

/* -------------------- utils & state -------------------- */
const LS_KEY = 'cardapio_min_v3';
const ADMIN_HASH_KEY = 'cardapio_admin_hash_v3';
const DEFAULT_HASH = '04440fb3544b19f7b83a8a1368a59d1b34a677382d8910c4efa05e1bfcd56c54'; // sha256('brisa2026')

const uid = (n=7)=> 'id_'+Math.random().toString(36).slice(2,2+n);
const listEl = document.getElementById('list');
const qInput = document.getElementById('q');
const logo = document.getElementById('logo');
const modalRoot = document.getElementById('modalRoot');
const fileIn = document.getElementById('fileIn');

let state = loadState() || initialData();
let isAdmin = false;

/* -------------------- rendering -------------------- */
function render(){
  listEl.innerHTML = '';
  const query = qInput.value.trim().toLowerCase();
  state.categories.forEach(cat=>{
    const catMatches = cat.name.toLowerCase().includes(query);
    const items = cat.items.filter(it=>{
      if(!query) return true;
      return it.name.toLowerCase().includes(query) || (it.notes||'').toLowerCase().includes(query);
    });
    if(!catMatches && items.length===0) return;

    const sec = document.createElement('section'); sec.className = 'cat';
    const head = document.createElement('div'); head.className = 'cat-head';
    const left = document.createElement('div'); left.innerHTML = `<div class="cat-name">${esc(cat.name)}</div><div class="cat-meta">${cat.items.length} itens</div>`;
    head.appendChild(left);

    if(isAdmin){
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
      const ed = mkBtn('editar', ()=> openCatEdit(cat.id));
      const rm = mkBtn('remover', ()=> delCategory(cat.id));
      right.appendChild(ed); right.appendChild(rm);
      head.appendChild(right);
    }
    sec.appendChild(head);

    const itemsWrap = document.createElement('div'); itemsWrap.className='items';
    items.forEach(it=>{
      if(!catMatches && query && !it.name.toLowerCase().includes(query) && !(it.notes||'').toLowerCase().includes(query)) return;
      const itEl = document.createElement('div'); itEl.className='item'; itEl.tabIndex = 0;
      itEl.addEventListener('click', ()=> openItemDetail(cat.id, it.id));
      const leftIt = document.createElement('div'); leftIt.className='item-left';
      leftIt.innerHTML = `<div class="iname">${esc(it.name)}</div>` + (it.notes?`<div class="inote">${esc(it.notes)}</div>`:'');
      const rightIt = document.createElement('div'); rightIt.style.display='flex'; rightIt.style.alignItems='center'; rightIt.style.gap='8px';
      const price = document.createElement('div'); price.className='price'; price.textContent = fmtBRL(it.price);
      rightIt.appendChild(price);
      if(isAdmin){
        const e = mkBtn('‚úé', ()=> openItemEdit(cat.id, it.id));
        const d = mkBtn('üóë', ()=> delItem(cat.id, it.id));
        rightIt.appendChild(e); rightIt.appendChild(d);
      }
      itEl.appendChild(leftIt); itEl.appendChild(rightIt);
      itemsWrap.appendChild(itEl);
    });

    sec.appendChild(itemsWrap);
    listEl.appendChild(sec);
  });

  // admin visibility & accessibility toggles
  toggleAdminUI(isAdmin);
}

/* -------------------- small helpers -------------------- */
function esc(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function fmtBRL(v){ return (v===undefined||v==='') ? '' : Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function mkBtn(label, onClick){
  const b = document.createElement('button'); b.className = 'btn'; b.textContent = label;
  b.addEventListener('click', (e)=> { e.stopPropagation(); onClick(); });
  return b;
}

/* -------------------- data model & persistence -------------------- */
function initialData(){
  return {
    updatedAt: new Date().toISOString(),
    categories: [
      { id:uid(), name:'Drinks e Caipirinhas (300ml)', items:[
        { id:uid(), name:'Caipirinha de Cacha√ßa', price:15, notes:'Morango ou Lim√£o' },
        { id:uid(), name:'Caipirinha de Vodka/Saqu√™', price:20, notes:'Morango ou Lim√£o' },
        { id:uid(), name:'Caipirinha Gourmet Brisa', price:35, notes:'Morango ou Lim√£o' },
        { id:uid(), name:'Gin Gin Eternity (500ml)', price:10, notes:'Melancia, Tropical, Ma√ß√£ Verde ou Royale' },
        { id:uid(), name:'Gin Eternity (700ml)', price:15, notes:'Melancia, Tropical, Ma√ß√£ Verde ou Royale' },
        { id:uid(), name:'Gin Premium & Red Bull', price:30, notes:'Melancia ou Tropical + Fruta' },
        { id:uid(), name:'Cop√£o Premium & Red Bull', price:40, notes:'Melancia ou Tropical + Fruta' },
        { id:uid(), name:'Moscow Mule Tradicional', price:30 }
      ]},
      { id:uid(), name:'Cervejas (Garrafa 600ml)', items:[
        { id:uid(), name:'Original', price:15 }, { id:uid(), name:'Spaten', price:17 }, { id:uid(), name:'Heineken', price:19 }
      ]},
      { id:uid(), name:'Baldes de Cerveja (4 unidades de 600ml)', items:[
        { id:uid(), name:'Balde Original', price:56 }, { id:uid(), name:'Balde Spaten', price:64 }, { id:uid(), name:'Balde Heineken', price:72 }
      ]},
      { id:uid(), name:'Long Neck e Diversos', items:[
        { id:uid(), name:'Budweiser', price:8 }, { id:uid(), name:'Spaten', price:10 }, { id:uid(), name:'Corona / Heineken / Heineken 0%', price:12 },
        { id:uid(), name:'Skol Beats / Smirnoff Ice', price:12 }, { id:uid(), name:'Balde Heineken Long Neck (10 un)', price:110 }
      ]},
      { id:uid(), name:'Combos (Garrafa + 4 Red Bull + Gelo de Sabor)', items:[
        { id:uid(), name:'Cavalo Branco / Passport / Smirnoff', price:160 }, { id:uid(), name:"Ballantine's / Red Label", price:200 },
        { id:uid(), name:"Jack Daniel's (Tradicional, Apple, Honey, Fire)", price:280 }, { id:uid(), name:'Old Parr / Black Label', price:320 },
        { id:uid(), name:'Ciroc / Grey Goose', price:320 }, { id:uid(), name:'Gin Tanqueray / Beefeater', price:250 }
      ]},
      { id:uid(), name:'Por√ß√µes', items:[
        { id:uid(), name:'Batata com Cheddar e Bacon', price:35 }, { id:uid(), name:'Frango √† Passarinho', price:45 }, { id:uid(), name:'Isca de Frango', price:45 },
        { id:uid(), name:'Isca de Peixe', price:60 }, { id:uid(), name:'Calabresa com Acebolada', price:35 }, { id:uid(), name:'Contra Fil√© com Batata', price:85 },
        { id:uid(), name:'T√°bua Brisa (Picanha com Batata - 600g + molhos/farofa)', price:100 }
      ]},
      { id:uid(), name:'Bebidas N√£o Alco√≥licas e Outros', items:[
        { id:uid(), name:'√Ågua (Com ou Sem G√°s)', price:5 }, { id:uid(), name:'√Ågua T√¥nica', price:6 }, { id:uid(), name:'Refrigerante ou Suco (Lata)', price:6 },
        { id:uid(), name:'Red Bull (Sabores)', price:12 }, { id:uid(), name:'Halls / Trident', price:3 }, { id:uid(), name:'Gelo de Sabor', price:3.5 }, { id:uid(), name:'Snickers', price:6 }
      ]},
      { id:uid(), name:'Narguil√©', items:[ { id:uid(), name:'Narguil√© Rosh', price:15 }, { id:uid(), name:'Aluguel de Narguil√©', price:40 } ] }
    ]
  };
}

function loadState(){
  try { const raw = localStorage.getItem(LS_KEY); if(!raw) return null; return JSON.parse(raw); } catch(e){ return null; }
}
function saveState(){ state.updatedAt = new Date().toISOString(); localStorage.setItem(LS_KEY, JSON.stringify(state)); }

/* -------------------- admin: hashing & auth -------------------- */
async function sha256(str){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function getAdminHash(){ return localStorage.getItem(ADMIN_HASH_KEY) || DEFAULT_HASH; }
async function checkPassword(pw){ const h = await sha256(pw||''); return h === getAdminHash(); }
function setAdminHash(hash){ localStorage.setItem(ADMIN_HASH_KEY, hash); }

/* -------------------- admin gesture (long press / multi taps) -------------------- */
let tapCount = 0, lastTap = 0, longTimer = null;
logo.addEventListener('touchstart', startLong); logo.addEventListener('mousedown', startLong);
logo.addEventListener('touchend', endLong); logo.addEventListener('mouseup', endLong);
logo.addEventListener('click', ()=> {
  const now = Date.now();
  if(now - lastTap < 700) tapCount++; else tapCount = 1;
  lastTap = now;
  if(tapCount >= 7){ promptAdmin(); tapCount = 0; }
});
function startLong(e){ e.preventDefault && e.preventDefault(); longTimer = setTimeout(()=> promptAdmin(), 1200); }
function endLong(){ if(longTimer){ clearTimeout(longTimer); longTimer = null; } }
async function promptAdmin(){
  const pw = prompt('√Årea interna ‚Äî senha:');
  if(pw === null) return;
  const ok = await checkPassword(pw);
  if(ok){ isAdmin = true; render(); alert('√Årea liberada'); }
  else alert('Senha errada');
}

/* -------------------- admin UI visibility & accessibility -------------------- */
function toggleAdminUI(enable){
  // select all elements with class 'admin'
  const adminEls = document.querySelectorAll('.admin');
  adminEls.forEach(el=>{
    if(enable){
      el.removeAttribute('aria-hidden');
      el.removeAttribute('hidden');
      // make focusable
      const controls = el.querySelectorAll('button,input,select,textarea');
      controls.forEach(c=>{ c.removeAttribute('tabindex'); c.removeAttribute('aria-hidden'); c.disabled = false; });
    } else {
      el.setAttribute('aria-hidden','true');
      el.setAttribute('hidden','');
      // remove from tab order and disable
      const controls = el.querySelectorAll('button,input,select,textarea');
      controls.forEach(c=>{ c.setAttribute('tabindex','-1'); c.setAttribute('aria-hidden','true'); c.disabled = true; });
    }
  });

  // body class for styling
  document.body.classList.toggle('is-admin', enable);
}

/* -------------------- CRUD actions -------------------- */
function addCategory(name){
  state.categories.push({ id: uid(), name: name || 'Nova se√ß√£o', items: [] });
  saveState(); render();
}
function editCategory(id, name){
  const c = state.categories.find(x=>x.id===id); if(c) c.name = name;
  saveState(); render();
}
function removeCategory(id){
  if(!confirm('Remover esta se√ß√£o?')) return;
  state.categories = state.categories.filter(c=>c.id!==id);
  saveState(); render();
}
function addItem(catId, payload){
  const c = state.categories.find(x=>x.id===catId); if(!c) return;
  c.items.push({ id: uid(), name: payload.name, price: Number(payload.price)||0, notes: payload.notes||'' });
  saveState(); render();
}
function editItem(catId, itemId, payload){
  const c = state.categories.find(x=>x.id===catId); if(!c) return;
  const it = c.items.find(i=>i.id===itemId); if(!it) return;
  it.name = payload.name; it.price = Number(payload.price)||0; it.notes = payload.notes||'';
  saveState(); render();
}
function removeItem(catId, itemId){
  if(!confirm('Remover este item?')) return;
  const c = state.categories.find(x=>x.id===catId); if(!c) return;
  c.items = c.items.filter(i=>i.id!==itemId);
  saveState(); render();
}

/* -------------------- modal system -------------------- */
function openModal(contentEl){
  modalRoot.innerHTML = '';
  modalRoot.classList.add('show');
  modalRoot.appendChild(contentEl);
  modalRoot.addEventListener('click', onBackdrop);
  modalRoot.setAttribute('aria-hidden','false');
}
function closeModal(){
  modalRoot.removeEventListener('click', onBackdrop);
  modalRoot.innerHTML = '';
  modalRoot.classList.remove('show');
  modalRoot.setAttribute('aria-hidden','true');
}
function onBackdrop(e){ if(e.target === modalRoot) closeModal(); }

/* -------------------- modals: add/edit -------------------- */
function addCategoryModal(){
  const box = document.createElement('div'); box.className='modal';
  box.innerHTML = `<h3>Nova se√ß√£o</h3>`;
  const f = document.createElement('div'); f.className='frow';
  const inp = document.createElement('input'); inp.placeholder = 'Nome da se√ß√£o';
  f.appendChild(inp); box.appendChild(f);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px';
  const c = document.createElement('button'); c.className='btn'; c.textContent='Cancelar'; c.onclick = closeModal;
  const s = document.createElement('button'); s.className='btn primary'; s.textContent='Criar'; s.onclick = ()=> { if(!inp.value.trim()) return alert('Nome obrigat√≥rio'); addCategory(inp.value.trim()); closeModal(); };
  actions.appendChild(c); actions.appendChild(s); box.appendChild(actions);
  openModal(box);
}

function addItemModal(){
  if(!state.categories.length){ return alert('Crie uma se√ß√£o primeiro'); }
  const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>Novo item</h3>`;
  const selRow = document.createElement('div'); selRow.className='frow';
  const sel = document.createElement('select'); state.categories.forEach(c=>{ const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; sel.appendChild(o); });
  selRow.appendChild(sel);
  const nameRow = document.createElement('div'); nameRow.className='frow'; const nameInp = document.createElement('input'); nameInp.placeholder='Nome do item'; nameRow.appendChild(nameInp);
  const priceRow = document.createElement('div'); priceRow.className='frow'; const priceInp = document.createElement('input'); priceInp.type='number'; priceInp.step='0.01'; priceInp.placeholder='Pre√ßo'; priceRow.appendChild(priceInp);
  const noteRow = document.createElement('div'); noteRow.className='frow'; const noteInp = document.createElement('textarea'); noteInp.rows=3; noteInp.placeholder='Notas (opcional)'; noteRow.appendChild(noteInp);
  box.appendChild(selRow); box.appendChild(nameRow); box.appendChild(priceRow); box.appendChild(noteRow);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px';
  const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancelar'; cancel.onclick = closeModal;
  const save = document.createElement('button'); save.className='btn primary'; save.textContent='Salvar'; save.onclick = ()=> {
    if(!nameInp.value.trim()) return alert('Nome obrigat√≥rio');
    addItem(sel.value, { name: nameInp.value.trim(), price: parseFloat(priceInp.value||'0'), notes: noteInp.value.trim() });
    closeModal();
  };
  actions.appendChild(cancel); actions.appendChild(save); box.appendChild(actions);
  openModal(box);
}

function openCatEdit(catId){
  const cat = state.categories.find(c=>c.id===catId); if(!cat) return;
  const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>Editar se√ß√£o</h3>`;
  const f = document.createElement('div'); f.className='frow'; const inp = document.createElement('input'); inp.value = cat.name; f.appendChild(inp); box.appendChild(f);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px';
  const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancelar'; cancel.onclick = closeModal;
  const save = document.createElement('button'); save.className='btn primary'; save.textContent='Salvar'; save.onclick = ()=> { if(!inp.value.trim()) return alert('Nome obrigat√≥rio'); editCategory(catId, inp.value.trim()); closeModal(); };
  actions.appendChild(cancel); actions.appendChild(save); box.appendChild(actions);
  openModal(box);
}

function openItemEdit(catId, itemId){
  const cat = state.categories.find(c=>c.id===catId); if(!cat) return; const it = cat.items.find(i=>i.id===itemId); if(!it) return;
  const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>Editar item</h3>`;
  const nameRow=document.createElement('div'); nameRow.className='frow'; const nameInp=document.createElement('input'); nameInp.value=it.name; nameRow.appendChild(nameInp);
  const priceRow=document.createElement('div'); priceRow.className='frow'; const priceInp=document.createElement('input'); priceInp.type='number'; priceInp.step='0.01'; priceInp.value=it.price; priceRow.appendChild(priceInp);
  const noteRow=document.createElement('div'); noteRow.className='frow'; const noteInp=document.createElement('textarea'); noteInp.rows=3; noteInp.value = it.notes||''; noteRow.appendChild(noteInp);
  box.appendChild(nameRow); box.appendChild(priceRow); box.appendChild(noteRow);
  const actions=document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px';
  const cancel=document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancelar'; cancel.onclick = closeModal;
  const save=document.createElement('button'); save.className='btn primary'; save.textContent='Salvar'; save.onclick = ()=> {
    if(!nameInp.value.trim()) return alert('Nome obrigat√≥rio');
    editItem(catId,itemId,{ name:nameInp.value.trim(), price:parseFloat(priceInp.value||'0'), notes:noteInp.value.trim() });
    closeModal();
  };
  actions.appendChild(cancel); actions.appendChild(save); box.appendChild(actions);
  openModal(box);
}

/* -------------------- view item detail -------------------- */
function openItemDetail(catId, itemId){
  const cat = state.categories.find(c=>c.id===catId); if(!cat) return; const it = cat.items.find(i=>i.id===itemId); if(!it) return;
  const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>${esc(it.name)}</h3>`;
  const content = document.createElement('div'); content.className='frow';
  content.innerHTML = `<div style="font-weight:800">${fmtBRL(it.price)}</div><div style="color:var(--muted)">${esc(it.notes||'')}</div>`;
  box.appendChild(content);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px';
  const ok = document.createElement('button'); ok.className='btn primary'; ok.textContent='Fechar'; ok.onclick = closeModal;
  actions.appendChild(ok); box.appendChild(actions);
  openModal(box);
}

/* -------------------- import/export/load -------------------- */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'cardapio.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importJSON(file){
  const r = new FileReader(); r.onload = ()=> {
    try{
      const json = JSON.parse(r.result);
      if(!json || !Array.isArray(json.categories)) throw new Error('Formato inv√°lido');
      if(!confirm('Substituir o card√°pio agora?')) return;
      state = json; saveState(); render(); alert('Pronto, carregado.');
    }catch(e){ alert('Erro: ' + e.message); }
  }; r.readAsText(file);
}
async function loadFromUrl(url){
  if(!url) return alert('Cole a URL antes');
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    if(!json || !Array.isArray(json.categories)) throw new Error('Formato inv√°lido');
    if(!confirm('Substituir o card√°pio local pelo conte√∫do externo?')) return;
    state = json; saveState(); render(); alert('Card√°pio atualizado');
  }catch(e){ alert('Erro ao trazer: ' + e.message); }
}

/* -------------------- admin panel (small) -------------------- */
function openAdminPanel(){
  const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>√Årea interna</h3>`;
  const change = document.createElement('button'); change.className='btn'; change.textContent='Trocar senha';
  change.onclick = ()=> { closeModal(); changePasswordModal(); };
  const exp = document.createElement('button'); exp.className='btn'; exp.textContent='Salvar c√≥pia'; exp.onclick = ()=> { exportJSON(); closeModal(); };
  const imp = document.createElement('button'); imp.className='btn'; imp.textContent='Carregar arquivo'; imp.onclick = ()=> { closeModal(); fileIn.click(); };
  const reset = document.createElement('button'); reset.className='btn'; reset.textContent='Voltar ao in√≠cio'; reset.onclick = ()=> { if(confirm('Resetar tudo?')){ state = initialData(); saveState(); render(); closeModal(); } };
  const row = document.createElement('div'); row.className='row'; row.style.gap='8px'; row.style.marginTop='12px';
  row.appendChild(change); row.appendChild(exp); row.appendChild(imp); row.appendChild(reset);
  box.appendChild(row);
  const closeBtn = document.createElement('div'); closeBtn.style.display='flex'; closeBtn.style.justifyContent='flex-end'; closeBtn.style.marginTop='12px';
  const c = document.createElement('button'); c.className='btn'; c.textContent='Fechar'; c.onclick = closeModal; closeBtn.appendChild(c);
  box.appendChild(closeBtn);
  openModal(box);
}

function changePasswordModal(){
  const box = document.createElement('div'); box.className='modal'; box.innerHTML = `<h3>Mudar senha</h3>`;
  const cur = document.createElement('input'); cur.type='password'; cur.placeholder='Senha atual';
  const nw = document.createElement('input'); nw.type='password'; nw.placeholder='Nova senha';
  const nw2 = document.createElement('input'); nw2.type='password'; nw2.placeholder='Confirmar nova senha';
  const f = document.createElement('div'); f.className='frow'; f.appendChild(cur); f.appendChild(nw); f.appendChild(nw2); box.appendChild(f);
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='flex-end'; actions.style.gap='8px';
  const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancelar'; cancel.onclick = closeModal;
  const save = document.createElement('button'); save.className='btn primary'; save.textContent='Salvar'; save.onclick = async ()=> {
    if(!cur.value || !nw.value) return alert('Preencha todos os campos');
    if(nw.value !== nw2.value) return alert('Confirma√ß√£o n√£o confere');
    const ok = await checkPassword(cur.value);
    if(!ok) return alert('Senha atual incorreta');
    const newHash = await sha256(nw.value);
    setAdminHash(newHash);
    alert('Senha atualizada');
    closeModal();
  };
  actions.appendChild(cancel); actions.appendChild(save); box.appendChild(actions);
  openModal(box);
}

/* -------------------- quick-add (fab) -------------------- */
function quickAdd(){
  if(!state.categories.length){ alert('Crie uma se√ß√£o primeiro'); return; }
  const name = prompt('Nome do item:'); if(!name) return;
  const priceRaw = prompt('Pre√ßo (ex: 15.50):','0'); if(priceRaw===null) return;
  const price = parseFloat(priceRaw.replace(',','.')) || 0;
  const cat = state.categories[0];
  addItem(cat.id, { name: name.trim(), price, notes: '' });
}

/* -------------------- event bindings -------------------- */
qInput.addEventListener('input', ()=> render());
document.getElementById('fab').addEventListener('click', ()=> { if(!isAdmin) return; quickAdd(); });
document.getElementById('btnAddCat').addEventListener('click', ()=> { if(!isAdmin) return; addCategoryModal(); });
document.getElementById('btnAddItem').addEventListener('click', ()=> { if(!isAdmin) return; addItemModal(); });
document.getElementById('btnAdmin').addEventListener('click', ()=> { if(!isAdmin) return; openAdminPanel(); });
document.getElementById('btnExport').addEventListener('click', ()=> { if(!isAdmin) return; exportJSON(); });
document.getElementById('btnLoadUrl').addEventListener('click', ()=> { if(!isAdmin) return; const url = document.getElementById('urlLoad').value.trim(); if(url) loadFromUrl(url); });
fileIn.addEventListener('change', (e)=> { const f = e.target.files[0]; if(!f) return; if(!isAdmin) return; importJSON(f); e.target.value=''; });

document.addEventListener('keydown', (e)=> { if(e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){ e.preventDefault(); qInput.focus(); } });

/* -------------------- init -------------------- */
render();
setInterval(()=> saveState(), 5000);

/* -------------------- exposed for console (power user) -------------------- */
window.cardapio = {
  get: ()=> JSON.parse(JSON.stringify(state)),
  login: async (pw)=> { if(await checkPassword(pw)){ isAdmin = true; render(); return true; } return false; },
  logout: ()=> { isAdmin = false; render(); },
  reset: ()=> { if(confirm('Resetar para os dados iniciais?')){ state = initialData(); saveState(); render(); } }
};
</script>
</body>
</html>
